import openai
from flask import Flask, render_template, request, jsonify, session
from dotenv import load_dotenv
import os
import random
import re

load_dotenv()

app = Flask(__name__)
app.secret_key = os.getenv("FLASK_SECRET_KEY", os.urandom(24))

openai.api_key = os.getenv("OPENAI_API_KEY")
MODEL_ENGINE = "gpt-3.5-turbo"

SITUATIONS = [
    {
        "id": 1,
        "description": "–ó–±—ñ—Ä–∫–∞ –º–µ–±–ª—ñ–≤ –Ω–∞ –æ–±‚Äô—î–∫—Ç—ñ",
        "requirements": "–ª–µ–≥–∫–∏–π, –∑—Ä—É—á–Ω–∏–π —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç –∑ —Ö–æ—Ä–æ—à–æ—é –µ—Ä–≥–æ–Ω–æ–º—ñ–∫–æ—é –¥–ª—è —Ç—Ä–∏–≤–∞–ª–æ—ó —Ä–æ–±–æ—Ç–∏",
        "correct_models": ["CD-12QX", "CD-12CX", "CD-12BC"],
        "wrong_models": ["CD-200BCULTRA", "CD-201HBC", "CD-218Q", "CD-200BCCOMPACT"],
        "hints": [
        "–ú–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–µ–Ω —Å–∞–º–µ 12V —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç",
        "–ó–±–∏—Ä–∞—é —à–∞—Ñ–∏ –π –∫—É—Ö–Ω—ñ, —á–∞—Å—Ç–æ –ø—Ä—è–º–æ —É –∫–ª—ñ—î–Ω—Ç–∞",
        "–¢—Ä–∏–º–∞—é —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É —Ä—É–∫–∞—Ö –ø–æ –∫—ñ–ª—å–∫–∞ –≥–æ–¥–∏–Ω",
        "–í–∞–∂–ª–∏–≤–æ, —â–æ–± —Ä—É–∫–∞ –Ω–µ –≤—Ç–æ–º–ª—é–≤–∞–ª–∞—Å—è",
        "–ö–æ–º—Ñ–æ—Ä—Ç –≤–∞–∂–ª–∏–≤—ñ—à–∏–π –∑–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å"
        ]
    },
    {
        "id": 2,
        "description": "–î–æ–º–∞—à–Ω—ñ–π —Ä–µ–º–æ–Ω—Ç",
        "requirements": "–Ω–µ–¥–æ—Ä–æ–≥–∏–π —Ç–∞ –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç –¥–ª—è –ø–æ–±—É—Ç–æ–≤–∏—Ö –∑–∞–¥–∞—á",
        "correct_models": ["CD-12QX", "CD-12CX", "CD-12BC"],
        "wrong_models": ["CD-200BCULTRA", "CD-201HBC", "CD-218Q", "CD-200BCCOMPACT"],
        "hints": [
        "–®—É–∫–∞—é 12V —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç –¥–ª—è –¥–æ–º—É",
        "–Ü–Ω–æ–¥—ñ —Ç—Ä–µ–±–∞ –ø–æ–≤—ñ—Å–∏—Ç–∏ –ø–æ–ª–∏—Ü—é –∞–±–æ –∑—ñ–±—Ä–∞—Ç–∏ –∫–æ–º–æ–¥",
        "–ù–µ —Ö–æ—á—É –ø–µ—Ä–µ–ø–ª–∞—á—É–≤–∞—Ç–∏ –∑–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å",
        "–¶—ñ–Ω—É—é –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—Å—Ç—å —ñ –∑—Ä—É—á–Ω—ñ—Å—Ç—å",
        "–ë—é–¥–∂–µ—Ç –¥–æ 2000 –≥—Ä–Ω"
        ]
    },
    {
        "id": 3,
        "description": "–ü–æ–¥–∞—Ä—É–Ω–æ–∫ —Ç–∞—Ç–æ–≤—ñ",
        "requirements": "–∫–æ–º–ø–∞–∫—Ç–Ω–∏–π, –ø—Ä–æ—Å—Ç–∏–π —É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç –¥–ª—è –±–∞–∑–æ–≤–∏—Ö —Ä–æ–±—ñ—Ç",
        "correct_models": ["CD-12QX", "CD-12CX", "CD-12BC"],
        "wrong_models": ["CD-200BCULTRA", "CD-201HBC", "CD-218Q", "CD-200BCCOMPACT"],
        "hints": [
        "–®—É–∫–∞—é 12V —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç —è–∫ –ø–æ–¥–∞—Ä—É–Ω–æ–∫",
        "–ë–∞—Ç—å–∫–æ —ñ–Ω–æ–¥—ñ —â–æ—Å—å –ø—ñ–¥–∫—Ä—É—á—É—î –≤–¥–æ–º–∞ –∞–±–æ –≤ –≥–∞—Ä–∞–∂—ñ",
        "–ô–æ–º—É –ø–æ—Ç—Ä—ñ–±–µ–Ω –ø—Ä–æ—Å—Ç–∏–π —Ç–∞ –Ω–∞–¥—ñ–π–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç",
        "–ë–µ–∑ —Å–∫–ª–∞–¥–Ω–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å",
        "–ì–æ–ª–æ–≤–Ω–µ ‚Äî —â–æ–± –±—É–≤ –ª–µ–≥–∫–∏–π —ñ –∑—Ä–æ–∑—É–º—ñ–ª–∏–π"
        ]
    },
    {
        "id": 4,
        "description": "–†–µ–º–æ–Ω—Ç –µ–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∏, —Ä–æ–±–æ—Ç–∞ –∑ –¥—Ä—ñ–±–Ω–∏–º–∏ –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è–º–∏",
        "requirements": "–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–±–µ—Ä—Ç—ñ–≤ —ñ —Ç–æ—á–Ω—ñ—Å—Ç—å",
        "correct_models": ["CD-12QX", "CD-12CX", "CD-12BC"],
        "wrong_models": ["CD-200BCULTRA", "CD-201HBC", "CD-218Q", "CD-200BCCOMPACT"],
        "hints": [
        "–ú–µ–Ω—ñ —Ç–æ—á–Ω–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω 12V —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç",
        "–ü—Ä–∞—Ü—é—é –∑ –¥—Ä—ñ–±–Ω–∏–º–∏ –≥–≤–∏–Ω—Ç–∞–º–∏ –π –µ–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–æ—é",
        "–í–∞–∂–ª–∏–≤–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å —ñ –∫–æ–Ω—Ç—Ä–æ–ª—å, —â–æ–± –Ω—ñ—á–æ–≥–æ –Ω–µ –∑—ñ–ø—Å—É–≤–∞—Ç–∏",
        "–°–∏–ª—å–Ω–æ—é –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—é –º–æ–∂–Ω–∞ –Ω–∞—à–∫–æ–¥–∏—Ç–∏",
        "–ü—Ä–∞—Ü—é—é —É –≤—É–∑—å–∫–∏—Ö –º—ñ—Å—Ü—è—Ö"
        ]
    },
    {
        "id": 5,
        "description": "–®—É—Ä—É–ø–æ–≤–µ—Ä—Ç –¥–ª—è –¥—Ä—É–∂–∏–Ω–∏",
        "requirements": "–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ª–µ–≥–∫–∏–π, –∑—Ä—É—á–Ω–∏–π, —ñ–∑ –ø—Ä–æ—Å—Ç–∏–º —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è–º",
        "correct_models": ["CD-12QX", "CD-12CX"],
        "wrong_models": ["CD-200BCULTRA", "CD-201HBC", "CD-218Q", "CD-200BCCOMPACT", "CD-12BC"],
        "hints": [
        "–ü–æ—Ç—Ä—ñ–±–µ–Ω 12V —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç, —â–æ–± –¥—Ä—É–∂–∏–Ω–∞ –º–æ–≥–ª–∞ —Å–∞–º–∞ –∑–±–∏—Ä–∞—Ç–∏ –º–µ–±–ª—ñ",
        "–í–∞–∂–ª–∏–≤–æ, —â–æ–± –±—É–≤ –ª–µ–≥–∫–∏–π —ñ –Ω–µ –ª—è–∫–∞–≤ —à—É–º–æ–º",
        "–ë–µ–∑ —Å–∫–ª–∞–¥–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π —ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å",
        "–ü–µ—Ä–µ–≤–∞–≥–∞ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π –∫–æ—Ä–ø—É—Å",
        "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è 1-2 —Ä–∞–∑–∏ –Ω–∞ –º—ñ—Å—è—Ü—å"
        ]
    },
    {
        "id": 6,
        "description": "–Ñ 12V –∞–∫—É–º—É–ª—è—Ç–æ—Ä 2Ah ‚Äî —à—É–∫–∞—é –±–µ–∑—â—ñ—Ç–∫–æ–≤–∏–π —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç –ø—ñ–¥ –Ω—å–æ–≥–æ",
        "requirements": "–∫–æ—Ä–ø—É—Å –±–µ–∑ –∞–∫—É–º—É–ª—è—Ç–æ—Ä–∞, —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å —ñ–∑ –Ω–∞—è–≤–Ω–∏–º –ê–ö–ë",
        "correct_models": ["CD-12BC"],
        "wrong_models": ["CD-200BCULTRA", "CD-201HBC", "CD-218Q", "CD-200BCCOMPACT", "CD-12QX", "CD-12CX"],
        "hints": [
        "–£ –º–µ–Ω–µ –≤–∂–µ —î 12V –∞–∫—É–º—É–ª—è—Ç–æ—Ä Dnipro-M –Ω–∞ 4Ah",
        "–®—É–∫–∞—é –ª–∏—à–µ —Ç—É—à–∫—É –±–µ–∑ –ê–ö–ë",
        "–•–æ—á—É –∑–µ–∫–æ–Ω–æ–º–∏—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –≤–∂–µ –Ω–∞—è–≤–Ω–∏–π –∞–∫—É–º—É–ª—è—Ç–æ—Ä",
        "–ë–∞–∂–∞–Ω–æ —â–æ—Å—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ",
        "–ù–µ —Ö–æ—á—É –±—Ä–∞—Ç–∏ –ø–æ—Ç—É–∂–Ω—ñ—à—É —Å–µ—Ä—ñ—é"
        ]
    },
    {
        "id": 7,
        "description": "–Ñ 12V –∞–∫—É–º—É–ª—è—Ç–æ—Ä 4Ah ‚Äî –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Å—É–º—ñ—Å–Ω–∞ —Ç—É—à–∫–∞",
        "requirements": "—Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å —ñ–∑ –∞–∫—É–º—É–ª—è—Ç–æ—Ä–æ–º —ñ –∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∞ –≤–∞–≥–∞",
        "correct_models": ["CD-12BC"],
        "wrong_models": ["CD-200BCULTRA", "CD-201HBC", "CD-218Q", "CD-200BCCOMPACT", "CD-12QX", "CD-12CX"],
        "hints": [
        "–ú–∞—é 12V –∞–∫—É–º—É–ª—è—Ç–æ—Ä Dnipro-M –Ω–∞ 4Ah",
        "–ù–µ —Ö–æ—á—É –∫—É–ø—É–≤–∞—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Ç —â–µ —Ä–∞–∑",
        "–¶—ñ–∫–∞–≤–∏—Ç—å –ª–∏—à–µ –∫–æ–º–ø–∞–∫—Ç–Ω–∞ –º–æ–¥–µ–ª—å",
        "–ë–∞–∂–∞–Ω–æ, —â–æ–± –Ω–µ –±—É–≤ –¥—É–∂–µ –≤–∞–∂–∫–∏–π —É —Ä—É—Ü—ñ",
        "–®—É—Ä—É–ø–æ–≤–µ—Ä—Ç ‚Äî –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å"
        ]
    },
    {
        "id": 8,
        "description": "–ö–ª—ñ—î–Ω—Ç –≤–∂–µ –º–∞—î –∑–∞—Ä—è–¥–∫—É —ñ 12V –∞–∫—É–º—É–ª—è—Ç–æ—Ä",
        "requirements": "–ª–∏—à–µ —Ç—É—à–∫–∞, –±–æ –≤—Å–µ —ñ–Ω—à–µ –≤–∂–µ —î",
        "correct_models": ["CD-12QX", "CD-12CX", "CD-12BC"],
        "wrong_models": ["CD-200BCULTRA", "CD-201HBC", "CD-218Q", "CD-200BCCOMPACT"],
        "hints": [
        "–£ –º–µ–Ω–µ –≤–∂–µ —î –∑–∞—Ä—è–¥–∫–∞ —ñ 12V –∞–∫—É–º—É–ª—è—Ç–æ—Ä –≤—ñ–¥ Dnipro-M",
        "–•–æ—á—É –∫—É–ø–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç",
        "–®—É—Ä—É–ø–æ–≤–µ—Ä—Ç –º–∞—î –±—É—Ç–∏ —Å—É–º—ñ—Å–Ω–∏–π —ñ–∑ –º–æ—ó–º –∞–∫—É–º—É–ª—è—Ç–æ—Ä–æ–º",
        "–†–æ–∑–≥–ª—è–¥–∞—é –±–µ–∑—â—ñ—Ç–∫–æ–≤–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç",
        "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º—É —á–∞—Å—Ç–æ, –∑–∞–π–º–∞—é—Å—å —Ä—ñ–∑–Ω–∏–º —Ä–µ–º–æ–Ω—Ç–æ–º"
        ]
    },
    {
        "id": 9,
        "description": "–®—É—Ä—É–ø–æ–≤–µ—Ä—Ç –¥–ª—è –¥–∞—á—ñ",
        "requirements": "–∫–æ–º–ø–∞–∫—Ç–Ω–∏–π, –ª–µ–≥–∫–∏–π, –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π",
        "correct_models": ["CD-12QX", "CD-12CX"],
        "wrong_models": ["CD-200BCULTRA", "CD-201HBC", "CD-218Q", "CD-200BCCOMPACT", "CD-12BC"],
        "hints": [
        "–®—É–∫–∞—é 12V —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç, —â–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –Ω–∞ –¥–∞—á—ñ",
        "–ö–æ—Ä–∏—Å—Ç—É—é—Å—å –Ω–µ—á–∞—Å—Ç–æ, –∞–ª–µ –º–∞—î –±—É—Ç–∏ –Ω–∞–¥—ñ–π–Ω–∏–π",
        "–•–æ—á—É –Ω–µ–¥–æ—Ä–æ–≥–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç",
        "–ú–∞—î –±—É—Ç–∏ –ø—Ä–æ—Å—Ç–∏–º –≤ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó",
        "–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ —â–æ—Å—å –Ω–∞–¥–ø–æ—Ç—É–∂–Ω–µ"
        ]
    },
    {
        "id": 101,
        "description": "–ú–æ–Ω—Ç–∞–∂ –≥—ñ–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω–Ω–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —É –≤–µ–ª–∏–∫–æ–º—É –æ–±—Å—è–∑—ñ",
        "requirements": "–ø–æ—Ç—É–∂–Ω–∏–π —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç, –∑–¥–∞—Ç–Ω–∏–π –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ø–æ –º–µ—Ç–∞–ª—É, –∑ –¥–æ–≤–≥–∏–º–∏ —Å–∞–º–æ—Ä—ñ–∑–∞–º–∏",
        "correct_models": ["CD-200BCULTRA", "CD-201HBC", "CD-200BCCOMPACT"],
        "wrong_models": ["CD-12QX", "CD-12CX", "CD-12BC", "CD-218Q"],
        "hints": [
        "–®—É—Ä—É–ø–æ–≤–µ—Ä—Ç –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—ñ–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω—É –Ω–∞ –º–µ—Ç–∞–ª–µ–≤—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ",
        "–ü—Ä–∞—Ü—é—é –≤–µ–ª–∏–∫–∏–º–∏ –æ–±'—î–º–∞–º–∏, —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —á–∞—Å—Ç–æ –≤ —Ä—É–∫–∞—Ö",
        "–°–∞–º–æ—Ä—ñ–∑–∏ –ø–æ –º–µ—Ç–∞–ª—É ‚Äî 3.5√ó35 –º–º —ñ –±—ñ–ª—å—à–µ",
        "–ü–æ—Ç—Ä—ñ–±–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å —ñ –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å",
        "12V ‚Äî —Å–ª–∞–±–µ–Ω—å–∫—ñ, –ø—Ä–æ–±—É–≤–∞–≤ ‚Äî –Ω–µ —Ç—è–≥–Ω—É—Ç—å"
        ]
    },
    {
        "id": 102,
        "description": "–°–≤–µ—Ä–¥–ª—ñ–Ω–Ω—è –º–µ—Ç–∞–ª—É —Ç–æ–≤—â–∏–Ω–æ—é –¥–æ 5 –º–º",
        "requirements": "—à—É—Ä—É–ø–æ–≤–µ—Ä—Ç —ñ–∑ –≤–∏—Å–æ–∫–∏–º –∫—Ä—É—Ç–Ω–∏–º –º–æ–º–µ–Ω—Ç–æ–º —ñ —Ö–æ—Ä–æ—à–æ—é –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—é",
        "correct_models": ["CD-200BCULTRA", "CD-201HBC", "CD-200BCCOMPACT"],
        "wrong_models": ["CD-12QX", "CD-12CX", "CD-12BC", "CD-218Q"],
        "hints": [
        "–ß–∞—Å—Ç–æ —Å–≤–µ—Ä–¥–ª—é –æ—Ç–≤–æ—Ä–∏ –≤ –º–µ—Ç–∞–ª—ñ 3‚Äì5 –º–º",
        "–ó–≤–∏—á–∞–π–Ω—ñ —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç–∏ –ø–µ—Ä–µ–≥—Ä—ñ–≤–∞—é—Ç—å—Å—è –∞–±–æ –Ω–µ —Å–ø—Ä–∞–≤–ª—è—é—Ç—å—Å—è",
        "–ü–æ—Ç—Ä—ñ–±–µ–Ω —Å–µ—Ä–π–æ–∑–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç",
        "12V ‚Äî –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å, –ø—Ä–æ–±—É–≤–∞–≤",
        "–ì–æ–ª–æ–≤–Ω–µ ‚Äî —Ç—è–≥–∞ —ñ –≤–∏—Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å"
        ]
    },
    {
        "id": 103,
        "description": "–ë—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ –∫–∞—Ä–∫–∞—Å–Ω–æ–≥–æ –±—É–¥–∏–Ω–∫—É",
        "requirements": "–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å, –∞–≤—Ç–æ–Ω–æ–º–Ω—ñ—Å—Ç—å, —Ä–æ–±–æ—Ç–∞ –∑ –¥–æ–≤–≥–∏–º–∏ –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è–º–∏",
        "correct_models": ["CD-200BCULTRA", "CD-201HBC", "CD-200BCCOMPACT"],
        "wrong_models": ["CD-12QX", "CD-12CX", "CD-12BC", "CD-218Q"],
        "hints": [
        "–†–æ–±–∏–º–æ –∫–∞—Ä–∫–∞—Å ‚Äî –¥–µ—Ä–µ–≤'—è–Ω—ñ –±–∞–ª–∫–∏, —Å–∞–º–æ—Ä—ñ–∑–∏ 100‚Äì120 –º–º",
        "–ü–æ—Ç—Ä—ñ–±–µ–Ω –¥—É–∂–µ —Å–∏–ª—å–Ω–∏–π —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç, –±–∞–∂–∞–Ω–æ –∑ –º–µ—Ç–∞–ª–µ–≤–∏–º —Ä–µ–¥—É–∫—Ç–æ—Ä–æ–º",
        "12V ‚Äî –≤–∑–∞–≥–∞–ª—ñ –Ω–µ –≤–∞—Ä—ñ–∞–Ω—Ç",
        "–•–æ—á—É –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –±–µ–∑ –º–µ—Ä–µ–∂—ñ, —Ç—ñ–ª—å–∫–∏ –∞–∫—É–º—É–ª—è—Ç–æ—Ä",
        "–¶—ñ–Ω—É—é –∑–Ω–æ—Å–æ—Å—Ç—ñ–π–∫—ñ—Å—Ç—å"
        ]
    },
    {
        "id": 104,
        "description": "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–∫—Ä—ñ–≤–ª—ñ –∑ –º–µ—Ç–∞–ª–æ–ø—Ä–æ—Ñ—ñ–ª—é",
        "requirements": "—à–≤–∏–¥–∫–∞ —Ç–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ —Ä–æ–±–æ—Ç–∞ –∑ –ø–æ–∫—Ä—ñ–≤–µ–ª—å–Ω–∏–º–∏ —Å–∞–º–æ—Ä—ñ–∑–∞–º–∏, –æ—Å–æ–±–ª–∏–≤–æ –∑ —à–∞–π–±–∞–º–∏",
        "correct_models": ["CD-200BCULTRA", "CD-201HBC", "CD-200BCCOMPACT"],
        "wrong_models": ["CD-12QX", "CD-12CX", "CD-12BC", "CD-218Q"],
        "hints": [
        "–ü—Ä–∞—Ü—é—é –Ω–∞ –¥–∞—Ö—É ‚Äî –º–æ–Ω—Ç—É—î–º–æ –º–µ—Ç–∞–ª–æ–ø—Ä–æ—Ñ—ñ–ª—å",
        "–®—É—Ä—É–ø–æ–≤–µ—Ä—Ç –º–∞—î –∫—Ä—É—Ç–∏—Ç–∏ —Å–∞–º–æ—Ä—ñ–∑–∏ –∑ —à–∞–π–±–æ—é –≤ –º–µ—Ç–∞–ª",
        "–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–æ—Ç—É–∂–Ω–∏–π —ñ –≤–∏—Ç—Ä–∏–≤–∞–ª–∏–π",
        "–ë–∞–∂–∞–Ω–æ 2 –ø–µ—Ä–µ–¥–∞—á—ñ",
        "12V ‚Äî –Ω–µ —Å–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è, –Ω–µ–º–∞—î —Ç—è–≥–∏"
        ]
    },
    {
        "id": 105,
        "description": "–†–æ–±–æ—Ç–∞ –∑ –≤–µ–ª–∏–∫–∏–º–∏ –º–µ–±–ª—è–º–∏ —ñ–∑ –º–∞—Å–∏–≤—É –¥–µ—Ä–µ–≤–∞",
        "requirements": "–≤–∏—Å–æ–∫–∏–π –∫—Ä—É—Ç–Ω–∏–π –º–æ–º–µ–Ω—Ç —ñ —Å—Ç–∞–±—ñ–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ –≤ —Ç–≤–µ—Ä–¥–æ–º—É –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ",
        "correct_models": ["CD-200BCULTRA", "CD-201HBC", "CD-200BCCOMPACT"],
        "wrong_models": ["CD-12QX", "CD-12CX", "CD-12BC", "CD-218Q"],
        "hints": [
        "–ó–±–∏—Ä–∞—é –º–µ–±–ª—ñ –∑ –º–∞—Å–∏–≤—É ‚Äî —Ç–≤–µ—Ä–¥–∞ –¥–µ—Ä–µ–≤–∏–Ω–∞",
        "–°–∞–º–æ—Ä—ñ–∑–∏ –≤–µ–ª–∏–∫–æ–≥–æ –¥—ñ–∞–º–µ—Ç—Ä—É, —á–∞—Å—Ç–æ —Ç—Ä–µ–±–∞ –¥–æ—Å–≤–µ—Ä–ª—é–≤–∞—Ç–∏",
        "–ü–æ—Ç—Ä—ñ–±–µ–Ω —Å–∏–ª—å–Ω–∏–π —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç",
        "–ó–≤–∏—á–∞–π–Ω—ñ –º–æ–¥–µ–ª—ñ –∞–±–æ –±—É–∫—Å—É—é—Ç—å, –∞–±–æ –≥—Ä—ñ—é—Ç—å—Å—è",
        "–ë–∞–∂–∞–Ω–æ ‚Äî –ø–æ—Ç—É–∂–Ω–∞ –º–æ–¥–µ–ª—å —ñ–∑ –º–µ—Ç–∞–ª–µ–≤–∏–º —Ä–µ–¥—É–∫—Ç–æ—Ä–æ–º"
        ]
    },
    {
        "id": 201,
        "description": "–ú–æ–Ω—Ç–∞–∂ –∫—É—Ö–æ–Ω–Ω–∏—Ö —à–∞—Ñ –Ω–∞ —Ü–µ–≥–ª—è–Ω—É —Å—Ç—ñ–Ω—É",
        "requirements": "–ø–æ—Ç—Ä—ñ–±–µ–Ω —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç —ñ–∑ —É–¥–∞—Ä–æ–º, –∑–¥–∞—Ç–Ω–∏–π —Å–≤–µ—Ä–¥–ª–∏—Ç–∏ —Ü–µ–≥–ª—É –ø—ñ–¥ –¥—é–±–µ–ª—ñ",
        "correct_models": ["CD-201HBC"],
        "wrong_models": ["CD-12QX", "CD-12CX", "CD-12BC", "CD-218Q", "CD-200BCULTRA", "CD-200BCCOMPACT"],
        "hints": [
        "–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–≤—ñ—Å–∏—Ç–∏ –∫—É—Ö–æ–Ω–Ω—ñ —à–∞—Ñ–∏ –Ω–∞ —Ü–µ–≥–ª—è–Ω—É —Å—Ç—ñ–Ω—É",
        "–°–≤–µ—Ä–¥–ª—é –æ—Ç–≤–æ—Ä–∏ –ø—ñ–¥ –¥—é–±–µ–ª—ñ √ò6‚Äì8 –º–º",
        "–ë–∞–∂–∞–Ω–æ, —â–æ–± –±—É–≤ —É–¥–∞—Ä–Ω–∏–π —Ä–µ–∂–∏–º",
        "12V –∞–±–æ –º–æ–¥–µ–ª—ñ –±–µ–∑ —É–¥–∞—Ä—É ‚Äî –Ω–µ –ø—ñ–¥—Ö–æ–¥—è—Ç—å",
        "CD-201HBC –º–µ–Ω—ñ —Ä–∞–¥–∏–ª–∏ —è–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç"
        ]
    },
    {
        "id": 202,
        "description": "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—Ä–æ–Ω—à—Ç–µ–π–Ω—ñ–≤ —Ç–µ–ª–µ–≤—ñ–∑–æ—Ä–∞ —É –∫–≤–∞—Ä—Ç–∏—Ä—ñ –∑ —Ü–µ–≥–ª—è–Ω–∏–º–∏ —Å—Ç—ñ–Ω–∞–º–∏",
        "requirements": "—É–¥–∞—Ä–Ω–∏–π —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–≤–µ—Ä–¥–ª—ñ–Ω–Ω—è –≤ —Ü–µ–≥–ª—ñ",
        "correct_models": ["CD-201HBC"],
        "wrong_models": ["CD-12QX", "CD-12CX", "CD-12BC", "CD-218Q", "CD-200BCULTRA", "CD-200BCCOMPACT"],
        "hints": [
        "–°—Ç—ñ–Ω–∏ ‚Äî —Å—Ç–∞—Ä–∞ —á–µ—Ä–≤–æ–Ω–∞ —Ü–µ–≥–ª–∞",
        "–¢—Ä–µ–±–∞ –ø—Ä–æ—Å–≤–µ—Ä–¥–ª–∏—Ç–∏ –æ—Ç–≤–æ—Ä–∏ –ø—ñ–¥ –∞–Ω–∫–µ—Ä–Ω—ñ –±–æ–ª—Ç–∏",
        "–ú—ñ–π –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç –Ω–µ —Å–ø—Ä–∞–≤–ª—è–≤—Å—è",
        "–ü–æ—Ç—Ä—ñ–±–µ–Ω —Å–∞–º–µ 20V –∑ —É–¥–∞—Ä–æ–º",
        "–®—É—Ä—É–ø–æ–≤–µ—Ä—Ç –º–∞—î –±—É—Ç–∏ –≤–∏—Ç—Ä–∏–≤–∞–ª–∏–º, –±–æ –ø—Ä–∞—Ü—é—é –ø–æ 5‚Äì6 –æ—Ç–≤–æ—Ä—ñ–≤ –∑–∞ —Ä–∞–∑"
        ]
    },
    {
        "id": 203,
        "description": "–ú–æ–Ω—Ç–∞–∂ –ø–µ—Ä–∏–ª —ñ —Ç—É—Ä–Ω—ñ–∫—ñ–≤ —É –ø—ñ–¥'—ó–∑–¥—ñ",
        "requirements": "—É–¥–∞—Ä–Ω–∏–π —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç –¥–ª—è —Ü–µ–≥–ª—è–Ω–æ—ó –∫–ª–∞–¥–∫–∏, –Ω–∞ –≤–∏—Å–æ—Ç—ñ, –≤ —Å–∫–ª–∞–¥–Ω–∏—Ö —É–º–æ–≤–∞—Ö",
        "correct_models": ["CD-201HBC"],
        "wrong_models": ["CD-12QX", "CD-12CX", "CD-12BC", "CD-218Q", "CD-200BCULTRA", "CD-200BCCOMPACT"],
        "hints": [
        "–í—Å—Ç–∞–Ω–æ–≤–ª—é—é –º–µ—Ç–∞–ª–µ–≤—ñ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó —É –ø—ñ–¥'—ó–∑–¥—ñ ‚Äî –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è –¥–æ —Ü–µ–≥–ª–∏",
        "–ß–∞—Å—Ç–æ –ø—Ä–∞—Ü—é—é –Ω–∞ –¥—Ä–∞–±–∏–Ω—ñ ‚Äî –≤–∞–∂–ª–∏–≤–æ, —â–æ–± —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –±—É–≤ –∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∏–π",
        "–ü–æ—Ç—Ä—ñ–±–µ–Ω —É–¥–∞—Ä —ñ —Ç–æ—á–Ω—ñ—Å—Ç—å, –±–æ —Å–≤–µ—Ä–¥–ª—é –≤ —à–≤–∞—Ö —ñ –≤ —Å–∞–º—ñ–π —Ü–µ–≥–ª—ñ",
        "CD-201HBC –º–∞—î –æ–ø—Ç–∏–º–∞–ª—å–Ω–µ —Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –≤–∞–≥–∏ —ñ —Å–∏–ª–∏",
        "–Ü–Ω—à—ñ –º–æ–¥–µ–ª—ñ –∞–±–æ —Å–ª–∞–±–∫—ñ, –∞–±–æ –±–µ–∑ —É–¥–∞—Ä—É"
        ]
    }
]

TOOL_MODELS = [
    "CD-12QX",
    "CD-200BCULTRA",
    "CD-201HBC",
    "CD-218Q",
    "CD-200BCCOMPACT",
    "CD-12CX",
    "CD-12BC"
]

UNACCEPTABLE_BEHAVIOR_PROMPT = """
–Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–∏—à–µ –º–∞—Ç—é–∫–∏ —Ç–∞ —Å–ª–æ–≤–∞, —è–∫—ñ —î –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–∏ –ø—Ä–∏ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—ñ –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏, 
—Ç–∏ –º–∞—î—à –ø—Ä–∞–≤–æ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –¥—ñ–∞–ª–æ–≥. –ü—Ä–∏–∫–ª–∞–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:
"—è –≤–∞—Å –Ω–µ –∑—Ä–æ–∑—É–º—ñ–≤"
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –∑–∞–≤–µ—Ä—à–∏ –¥—ñ–∞–ª–æ–≥.
"""
RELEVANT_KEYWORDS = [
    "—Ä–æ–±", "–∑–∞–≤–¥–∞–Ω", "–∞–∫—É–º—É–ª—è—Ç–æ—Ä", "–¥—ñ–∞–º–µ—Ç", "–º–µ—Ç–∞–ª", "–∑–∞–¥–∞—á", "–º–µ—Ä–µ–∂–µ–≤", "–ø—Ä–∞—Ü", "—è–∫", "—á–æ–º—É", "—á–∏", "—è–∫–∏–π", "—è–∫–∞", "—è–∫–µ",
    "–¥–µ—Ä–µ–≤–æ", "–±–µ—Ç–æ–Ω", "–Ω–∞—Å–∞–¥–∫–∏", "—Ä–µ–∂–∏–º", "–∫—Ä—É—Ç–Ω–∏–π", "–º–æ–º–µ–Ω—Ç", "–ø–æ—Ç—É–∂–Ω", "–ø—Ä–∞—Ü", "–∫–æ–º–ø–∞–∫", "—Å–≤–µ—Ä", "–∫–µ–π—Å", "–ø–æ—Å—Ç—ñ–π–Ω", "–æ–±–µ—Ä—Ç"
]

def is_relevant_question(text):
    return any(keyword in text for keyword in RELEVANT_KEYWORDS)

def is_question(message):
    return "?" in message or message.strip().lower().startswith((
        "–ø—Ä–∞—Ü", "—è–∫", "—á–æ–º—É", "—á–∏", "—è–∫–∏–π", "—è–∫–∞", "—è–∫–µ", "—Ä–æ–±",
        "–∑–∞–≤–¥–∞–Ω", "–∞–∫—É–º—É–ª—è—Ç–æ—Ä", "–¥—ñ–∞–º–µ—Ç", "–º–µ—Ç–∞–ª", "–∑–∞–¥–∞—á", "–º–µ—Ä–µ–∂–µ–≤",
        "–¥–µ—Ä–µ–≤–æ", "–º–∞—Ç–µ—Ä", "–Ω–∞—Å–∞–¥–∫–∏", "—Ä–µ–∂–∏–º", "–∫—Ä—É—Ç–Ω–∏–π", "–º–æ–º–µ–Ω—Ç",
        "–ø–æ—Ç—É–∂–Ω", "–±—É–¥", "—Å–≤–µ—Ä"
    ))

def init_conversation():
    selected_situation = random.choice(SITUATIONS)
    session['situation'] = selected_situation
    session['current_situation_id'] = selected_situation["id"]
    session['available_models'] = TOOL_MODELS  # –ü–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ –º–æ–¥–µ–ª—ñ
    session['stage'] = 1
    session['chat_active'] = True
    session['message_count'] = 0
    session['wrong_model_attempts'] = 0
    session['question_count'] = 0
    session['unique_questions'] = []
    session['off_topic_count'] = 0
    session['misunderstood_count'] = 0
    session['objection_round'] = 1
    session['warning_count'] = 0

    system_prompt = f"""
    –¢–∏ ‚Äî –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π **–∫–ª—ñ—î–Ω—Ç –º–∞–≥–∞–∑–∏–Ω—É**, —è–∫–∏–π **–ø—Ä–∏–π—à–æ–≤ –∫—É–ø–∏—Ç–∏ —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç**.  
    –¢–≤–æ—è **—î–¥–∏–Ω–∞ –º–µ—Ç–∞** ‚Äî **–æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –¥–ª—è –ø–æ–∫—É–ø–∫–∏** –∑–≥—ñ–¥–Ω–æ —Ç–≤–æ—î—ó —Å–∏—Ç—É–∞—Ü—ñ—ó.
    –ù–µ –≤–∏—Å–≤—ñ—Ç–ª—é–π —Å–∏—Ç—É–∞—Ü—ñ—é –ø–æ–≤–Ω—ñ—Å—Ç—é. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å—Ç–∞–≤–∏—Ç—å –ø–∏—Ç–∞–Ω–Ω—è ‚Äì —Ç–∏ **–≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î—à –ø–æ –æ–¥–Ω–æ–º—É —Ä–µ—á–µ–Ω–Ω—é**. 
    –¢–∏ **–Ω–µ —î –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º**, **–Ω–µ –¥–æ–ø–æ–º–∞–≥–∞—î—à** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É, **–Ω–µ –ø—Ä–æ–ø–æ–Ω—É—î—à –º–æ–¥–µ–ª—ñ**, **–Ω–µ —Å—Ç–∞–≤–∏—à –∑—É—Å—Ç—Ä—ñ—á–Ω–∏—Ö –∑–∞–ø–∏—Ç–∞–Ω—å**.
    –¢–∏ –Ω–µ —î –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º. –¢–∏ –∫–ª—ñ—î–Ω—Ç, —è–∫–∏–π —Ö–æ—á–µ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –≤—Å–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–µ –ø—Ä–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —â–æ–±–∏ –ø—Ä–∏–π–Ω—è—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–∫—É–ø–∫—É.  
    –¢–∏ —É—Ç–æ—á–Ω—é—î—à –¥–µ—Ç–∞–ª—ñ, –≤–∏—Å–ª–æ–≤–ª—é—î—à —Å–≤–æ—ó –≤–∏–º–æ–≥–∏. 

    –¢–≤–æ—è —Å–∏—Ç—É–∞—Ü—ñ—è: {selected_situation['description']}
    –¢–≤–æ—ó –ø–æ—Ç—Ä–µ–±–∏: {selected_situation['requirements']}

    {UNACCEPTABLE_BEHAVIOR_PROMPT}

    –ü–æ–≤–µ–¥—ñ–Ω–∫–∞:
    - –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≥—Ä—É–±–∏–π –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ª–∞–π–ª–∏–≤—É –ª–µ–∫—Å–∏–∫—É ‚Äî –∑–∞–≤–µ—Ä—à—É–π –¥—ñ–∞–ª–æ–≥ —Ñ—Ä–∞–∑–æ—é "–Ø –í–∞—Å –Ω–µ –∑—Ä–æ–∑—É–º—ñ–≤"
    - –í —ñ–Ω—à–æ–º—É –≤–∏–ø–∞–¥–∫—É ‚Äî –∑–∞–¥–∞–≤–∞–π –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –≤–∏—Å–ª–æ–≤–ª—é–π —Å–≤–æ—é –¥—É–º–∫—É.

    –ü–æ—á–∏–Ω–∞–π —Ä–æ–∑–º–æ–≤—É –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ:  
    "–î–æ–±—Ä–∏–π –¥–µ–Ω—å, –º–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–µ–Ω —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç."
    """

    return [
        {"role": "system", "content": system_prompt},
        {"role": "assistant", "content": "–î–æ–±—Ä–∏–π –¥–µ–Ω—å, –º–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–µ–Ω —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç."}
    ]

def is_relevant_question_gpt(question, situation_description):
    prompt = f"""
    –ß–∏ —î —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–º –¥–ª—è –≤–∏–±–æ—Ä—É —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ —Ü—ñ—î—ó —Å–∏—Ç—É–∞—Ü—ñ—ó?
    –°–∏—Ç—É–∞—Ü—ñ—è: {situation_description}
    
    –í—Ä–∞—Ö–æ–≤—É–π —Ç–∞–∫—ñ –∫—Ä–∏—Ç–µ—Ä—ñ—ó:
    - –ü–∏—Ç–∞–Ω—å –ø—Ä–æ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å, –∞–∫—É–º—É–ª—è—Ç–æ—Ä, –∫—Ä—É—Ç–Ω–∏–π –º–æ–º–µ–Ω—Ç)
    - –ü–∏—Ç–∞–Ω—å –ø—Ä–æ —Å—Ñ–µ—Ä—É –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è (–¥–µ—Ä–µ–≤–æ, –º–µ—Ç–∞–ª, –±–µ—Ç–æ–Ω)
    - –ü–∏—Ç–∞–Ω—å –ø—Ä–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å (—Ä–µ–∂–∏–º–∏ —Ä–æ–±–æ—Ç–∏, –Ω–∞—Å–∞–¥–∫–∏)
    - –ü–∏—Ç–∞–Ω—å –ø—Ä–æ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∞–±–æ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

    –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ª–∏—à–µ '—Ç–∞–∫' –∞–±–æ '–Ω—ñ'. –ü–∏—Ç–∞–Ω–Ω—è: "{question}"
    """
    try:
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            temperature=0,
            max_tokens=10
        )
        answer = response.choices[0].message["content"].lower()
        print(f"[DEBUG] –í—ñ–¥–ø–æ–≤—ñ–¥—å GPT –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—Å—Ç—å –ø–∏—Ç–∞–Ω–Ω—è: {answer}")
        return "—Ç–∞–∫" in answer
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—ñ: {str(e)}")
        return False

def match_model(user_input, available_models):
    user_model = re.sub(r'[^A-Z0-9-]', '', user_input.upper())
    # –¢–æ—á–Ω–µ —Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è, –∞ –Ω–µ –ø–æ—à—É–∫ –ø—ñ–¥—Ä—è–¥–∫–∞:
    for model in available_models:
        clean_model = re.sub(r'[^A-Z0-9-]', '', model.upper())
        if user_model == clean_model:
            return model
    return None

@app.route('/')
def home():
    if "unique_questions" not in session:
        session["unique_questions"] = []
    return render_template('index.html')

@app.route('/start_chat')
def start_chat():
    session['history'] = init_conversation()
    # –Ø–∫—â–æ —Ç—Ä–µ–±–∞, —Å–∫–∏–Ω—å —ñ–Ω—à—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
    session["stage"] = 1
    session["question_count"] = 0
    session["model"] = None
    session["chat_active"] = True
    session["unique_questions"] = []
    return jsonify({"reply": session['history'][1]['content']})

@app.route("/restart-chat", methods=["POST"])
def restart_chat():
    keys_to_clear = [
        "history", "stage", "question_count", "model", "chat_active",
        "unique_questions", "misunderstood_count", "available_models",
        "wrong_model_attempts", "user_answers", "off_topic_count",
        "objection_round", "generated_questions", "current_question_index",
        "current_situation_id", "situation", "last_seller_reply",
        "current_objection", "hint_shown", "question_scores", "model_score", "total_score", "seller_replies"
    ]
    for key in keys_to_clear:
        session.pop(key, None)
    return jsonify({"message": "–°–µ—Å—ñ—é —Å–∫–∏–Ω—É—Ç–æ."})

@app.route("/show_models", methods=["POST"])
def show_models():
    session["stage"] = 2
    return jsonify({
        "models": session.get("available_models", []),
        "stage": 2
    })

@app.route("/chat", methods=["POST"])
def chat():
    print("–î–æ—Å—Ç—É–ø–Ω—ñ –º–æ–¥–µ–ª—ñ –¥–ª—è –≤–∏–±–æ—Ä—É:", session.get("available_models"))
    user_input = request.json.get("message", "").strip()

    print(f"[DEBUG] –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–ø–∏—Å–∞–≤: {user_input}")
    print(f"[DEBUG] –ü–æ—Ç–æ—á–Ω–∞ —Å—Ç–∞–¥—ñ—è: {session.get('stage')}")

    session.setdefault("misunderstood_count", 0)
    session.setdefault("objection_round", 1)

    if "history" not in session or not session["history"]:
        session["history"] = init_conversation()
        session["stage"] = 1
        session["question_count"] = 0
        session["model"] = None
        session["chat_active"] = True
        session["unique_questions"] = []
        session["misunderstood_count"] = 0
        session["wrong_model_attempts"] = 0
        session["user_answers"] = {}
        session["question_scores"] = []
        session["model_score"] = 0
        session["objection_round"] = 1
        session["seller_replies"] = []
        session["total_score"] = 0

        # --- –û–±—Ä–æ–±–∫–∞ –µ—Ç–∞–ø—É –≤–∏–±–æ—Ä—É –º–æ–¥–µ–ª—ñ ---

    if session["stage"] == 2:
        print(f"[DEBUG] –í—Ö–æ–¥–∏–º–æ –≤ stage 2 ‚Äî –æ–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É –º–æ–¥–µ–ª—ñ: {user_input}")
            
        user_model = re.sub(r'[^A-Z0-9-]', '', user_input.upper())
        matched_models = [m for m in session["available_models"] if user_model in m.upper()]
        index = session.get('current_question_index', 0)

        if not matched_models:
            session["chat_active"] = False
            session["model_score"] = 0  # ‚ùóÔ∏è0 –±–∞–ª—ñ–≤ –∑–∞ –Ω–µ—ñ—Å–Ω—É—é—á—É –º–æ–¥–µ–ª—å
            return jsonify({
                "reply": f"–í–∏ –æ–±—Ä–∞–ª–∏ ¬´{user_input}¬ª, –∞–ª–µ —Ç–∞–∫–æ—ó –º–æ–¥–µ–ª—ñ –Ω–µ–º–∞—î –≤ —Å–ø–∏—Å–∫—É. –ó–∞–≤–µ—Ä—à—É—é –¥—ñ–∞–ª–æ–≥.",
                "chat_ended": True,
                "show_restart_button": True
            })

        user_model = matched_models[0].upper()
        current_situation = next((s for s in SITUATIONS if s["id"] == session.get("current_situation_id")), None)
        if not current_situation:
            return jsonify({
                "reply": "–ü–æ–º–∏–ª–∫–∞: —Å–∏—Ç—É–∞—Ü—ñ—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞.",
                "chat_ended": True,
                "show_restart_button": True
            })

        correct_models = [model.upper() for model in current_situation["correct_models"]]

        # –û—Ü—ñ–Ω–∫–∞ –º–æ–¥–µ–ª—ñ:
        if user_model in correct_models:
            session["model_score"] = 2
            print(f"[DEBUG] –ë–∞–ª–∏ –∑–∞ –≤–∏–±—ñ—Ä –º–æ–¥–µ–ª—ñ: {session['model_score']}")
        elif user_model in [m.upper() for m in TOOL_MODELS]:
            session["model_score"] = 1
        else:
            session["model_score"] = 0  # –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–æ –Ω–µ –º–∞—î –±—É—Ç–∏, –±–æ –º–∏ –≤–∂–µ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä—É–≤–∞–ª–∏ –Ω–∞—è–≤–Ω—ñ

        if user_model in correct_models:
            session["model"] = user_model
            session["stage"] = 3
            session["current_question_index"] = 0
            session["user_answers"] = {}
            session["question_scores"] = []
            session["model_score"] = 0  


            prompt = f"""–¢–∏ –∫–ª—ñ—î–Ω—Ç, —è–∫–∏–π –æ–±—Ä–∞–≤ —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç {user_model} –¥–ª—è {session['situation']['description']}.\n
            –ó–≥–µ–Ω–µ—Ä—É–π 3 –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ **–∫—Ä—É—Ç–Ω–∏–π –º–æ–º–µ–Ω—Ç**, **–∑–æ–≤–Ω—ñ—à–Ω—é –±—É–¥–æ–≤—É** —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—ó —Ü—å–æ–≥–æ —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç–∞."""

            try:
                response = openai.ChatCompletion.create(
                    model="gpt-3.5-turbo",
                    messages=[
                        {"role": "system", "content": "–¢–∏ ‚Äî –∫–ª—ñ—î–Ω—Ç, —è–∫–∏–π –º–∞—î –∑–∞–¥–∞—Ç–∏ —É—Ç–æ—á–Ω—é—é—á—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –º–æ–¥–µ–ª—å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞."},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=0.6,
                    max_tokens=200
                )
                content = response.choices[0].message.get("content", "")
                questions = [line.strip(" 1234567890.-") for line in content.split('\n') if line.strip()]
                session["generated_questions"] = questions
                session.modified = True

                first_question = questions[0] if questions else "–Ø–∫–µ –ø–µ—Ä—à–µ –≤–∞—à–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Ü—é –º–æ–¥–µ–ª—å?"

                return jsonify({
                    "reply": f"–î–æ–±—Ä–µ, –º–æ–¥–µ–ª—å {user_model} –º–µ–Ω—ñ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å. –ó–∞—Ä–∞–∑ –∑–∞–¥–∞–º –∫—ñ–ª—å–∫–∞ —É—Ç–æ—á–Ω—é—é—á–∏—Ö –ø–∏—Ç–∞–Ω—å –ø–æ —á–µ—Ä–∑—ñ.\n\n{first_question}",
                    "chat_ended": False,
                    "stage": 3
                })

            except Exception as e:
                return jsonify({
                    "reply": "–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø–∏—Ç–∞–Ω—å. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",
                    "chat_ended": False
                })

        else:
            session["chat_active"] = False
            return jsonify({
                "reply": f"–ú–æ–¥–µ–ª—å ¬´{user_model}¬ª –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–æ –≤–∞—à–æ—ó –∑–∞–¥–∞—á—ñ. –ó–∞–≤–µ—Ä—à—É—é –¥—ñ–∞–ª–æ–≥.",
                "chat_ended": True,
                "show_restart_button": True,
                "hide_choose_model_btn": True
            })
    
    elif session["stage"] == 3:
        if 'generated_questions' not in session or not session['generated_questions']:
            return jsonify({
                "reply": "–ü–∏—Ç–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ. –î–∞–≤–∞–π—Ç–µ –ø–æ—á–Ω–µ–º–æ —Å–ø–æ—á–∞—Ç–∫—É.",
                "chat_ended": True,
                "show_restart_button": True
            })

        index = session.get('current_question_index', 0)
        current_question = session['generated_questions'][index]

        # GPT: –æ—Ü—ñ–Ω–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–∞ —à–∫–∞–ª–æ—é 0‚Äì2
        gpt_prompt = f"""
    –û—Ü—ñ–Ω–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è.
    –ü–∏—Ç–∞–Ω–Ω—è: "{current_question}"
    –í—ñ–¥–ø–æ–≤—ñ–¥—å: "{user_input}"

    –û—Ü—ñ–Ω–∏ –∑–∞ —à–∫–∞–ª–æ—é:
    2 ‚Äî –ø–æ–≤–Ω–∞, —Ç–æ—á–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ —Å—É—Ç—ñ
    1 ‚Äî —á–∞—Å—Ç–∫–æ–≤–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞ –∞–±–æ –ø–æ–≤–µ—Ä—Ö–Ω–µ–≤–∞
    0 ‚Äî –Ω–µ –ø–æ —Ç–µ–º—ñ –∞–±–æ –∑–∞–Ω–∞–¥—Ç–æ –∑–∞–≥–∞–ª—å–Ω–∞

    –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ª–∏—à–µ —Ü–∏—Ñ—Ä–æ—é: 0, 1 –∞–±–æ 2.
    """

        try:
            evaluation = openai.ChatCompletion.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": "–¢–∏ –æ—Ü—ñ–Ω—é—î—à –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–∞ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ª–∏—à–µ —á–∏—Å–ª–æ–º: 0, 1 –∞–±–æ 2."},
                    {"role": "user", "content": gpt_prompt}
                ],
                temperature=0,
                max_tokens=10
            )

            score_text = evaluation.choices[0].message["content"].strip()
            score = int(score_text) if score_text.isdigit() else 0

            session.setdefault("user_answers", {})[current_question] = {
                "answer": user_input,
                "score": score
            }

            total_answer_score = sum(ans["score"] for ans in session["user_answers"].values())
            print(f"[DEBUG] –ü–æ—Ç–æ—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –±–∞–ª—ñ–≤ –∑–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: {total_answer_score}")

            session['current_question_index'] += 1

            if session['current_question_index'] < len(session['generated_questions']):
                next_question = session['generated_questions'][session['current_question_index']]
                return jsonify({
                    "reply": next_question,
                    "chat_ended": False
                })
            else:
                # –ö–æ–ª–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚Äî —Ä–∞—Ö—É—î–º–æ –ø—ñ–¥—Å—É–º–æ–∫
                session["stage"] = 4
                total_score = sum(ans["score"] for ans in session["user_answers"].values())

                if total_score >= 5:
                    feedback = "–í–∞—à—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —á—É–¥–æ–≤—ñ ‚Äì –≤–∏–¥–Ω–æ, —â–æ –≤–∏ –¥–æ–±—Ä–µ –æ—Ä—ñ—î–Ω—Ç—É—î—Ç–µ—Å—å —É –ø—Ä–æ–¥—É–∫—Ç—ñ."
                elif total_score >= 3:
                    feedback = "–í–∞—à—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–∞–≥–∞–ª–æ–º –Ω–µ–ø–æ–≥–∞–Ω—ñ, –∞–ª–µ —î –Ω–∞–¥ —á–∏–º –ø–æ–¥—É–º–∞—Ç–∏."
                else:
                    feedback = "–°—Ö–æ–∂–µ, —É –≤–∞—Å –∑–∞–ª–∏—à–∏–ª–∏—Å—è –ø–∏—Ç–∞–Ω–Ω—è —â–æ–¥–æ –º–æ–¥–µ–ª—ñ. –†–∞–¥–∂—É —É—Ç–æ—á–Ω–∏—Ç–∏ —â–µ –¥–µ—â–æ."

                # –ü–æ—á–∏–Ω–∞—î–º–æ —Å—Ç–∞–¥—ñ—é –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è –∑ —Ñ—ñ–¥–±–µ–∫–æ–º
                objections = [
                    "–ú–µ–Ω—ñ –∑–¥–∞—î—Ç—å—Å—è, —Ü–µ —Ç—Ä–æ—Ö–∏ –¥–æ—Ä–æ–≥—É–≤–∞—Ç–æ.",
                    "–ê —Ü–µ —Ç–æ—á–Ω–æ –Ω–µ —è–∫–∞—Å—å –∫–∏—Ç–∞–π—Å—å–∫–∞ –º–æ–¥–µ–ª—å?",
                    "–í–∞—à–∞ –≥–∞—Ä–∞–Ω—Ç—ñ—è —Ç–æ—á–Ω–æ –ø—Ä–∞—Ü—é—î?",
                    "–Ø –±–∞—á–∏–≤ –≤ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ –¥–µ—à–µ–≤—à–µ."
                ]
                chosen_objection = random.choice(objections)
                session["current_objection"] = chosen_objection
                session["objection_round"] = 1

                return jsonify({
                    "reply": f"{feedback}\n\n–•–º... {chosen_objection}",
                    "chat_ended": False,
                    "stage": 4
                })

        except Exception as e:
            return jsonify({
                "reply": "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",
                "chat_ended": False
            })

    # --- –û–±—Ä–æ–±–∫–∞ –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è (stage 4) ---
    elif session["stage"] == 4:
        objection = session.get("current_objection", "–ó–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è")
        seller_reply = user_input

        # üõ†Ô∏è –¢–£–¢ —ñ –º–∞—î –±—É—Ç–∏ –≤–∏–∑–Ω–∞—á–µ–Ω–æ!
        MAX_ROUNDS = 3
        current_round = session.get("objection_round", 1)

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –ø—Ä–æ–¥–∞–≤—Ü—è
        if "seller_replies" not in session:
            session["seller_replies"] = []
        session["seller_replies"].append(seller_reply)

        # –†–∞—É–Ω–¥–∏ 1‚Äì2 ‚Äî —É—Ç–æ—á–Ω–µ–Ω–Ω—è
        if current_round in [1, 2]:
            history = "\n".join([f"–†–∞—É–Ω–¥ {i+1}: {reply}" for i, reply in enumerate(session["seller_replies"])])

            gpt_prompt = f"""
    –ó–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞: '{objection}'
    –Ü—Å—Ç–æ—Ä—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –ø—Ä–æ–¥–∞–≤—Ü—è:
    {history}
    –°—Ñ–æ—Ä–º—É–ª—é–π –≤–≤—ñ—á–ª–∏–≤–µ —É—Ç–æ—á–Ω–µ–Ω–Ω—è, —è–∫–µ –¥–æ–ø–æ–º–æ–∂–µ –∑‚Äô—è—Å—É–≤–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ.
    –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –æ–¥–Ω–µ –∑ —Ç–∞–∫–∏—Ö –ø—ñ–¥—Ö–æ–¥—ñ–≤:
    - –£—Ç–æ—á–Ω–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –∞—Å–ø–µ–∫—Ç
    - –í–∏—Å–ª–æ–≤–∏ –æ–±–µ—Ä–µ–∂–Ω–∏–π —Å—É–º–Ω—ñ–≤
    - –ü–æ–ø—Ä–æ—Å–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–∫–ª–∞–¥–∏
    """

            try:
                response = openai.ChatCompletion.create(
                    model="gpt-3.5-turbo",
                    messages=[
                        {"role": "system", "content": "–¢–∏ ‚Äî –∫–ª—ñ—î–Ω—Ç, —è–∫–∏–π –ø–æ—Ç—Ä–µ–±—É—î –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø–æ—è—Å–Ω–µ–Ω—å. –ë—É–¥—å –≤–≤—ñ—á–ª–∏–≤–∏–º, –∞–ª–µ –¥–æ–ø–∏—Ç–ª–∏–≤–∏–º."},
                        {"role": "user", "content": gpt_prompt}
                    ],
                    temperature=0.6,
                    max_tokens=250
                )

                reply = response.choices[0].message["content"].strip()
                session["objection_round"] += 1

                return jsonify({
                    "reply": reply,
                    "chat_ended": False,
                    "current_round": session["objection_round"]
                })
            except Exception as e:
                print(f"–ü–æ–º–∏–ª–∫–∞ API OpenAI: {str(e)}")
                return jsonify({
                    "reply": "–í–∏–±–∞—á—Ç–µ, –≤–∏–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞. –ú–æ–∂–µ—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞, —É—Ç–æ—á–Ω–∏—Ç–∏ —Å–≤–æ—é –¥—É–º–∫—É?",
                    "chat_ended": False
                })

        # –†–∞—É–Ω–¥ 3 ‚Äî —Ñ—ñ–Ω–∞–ª—å–Ω–∞ –æ—Ü—ñ–Ω–∫–∞
        elif current_round == MAX_ROUNDS:
            full_history = "\n".join([f"–†–∞—É–Ω–¥ {i+1}: {reply}" for i, reply in enumerate(session["seller_replies"])])

            evaluation_prompt = f"""
    –ó–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞: '{objection}'
    –ü–æ–≤–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—Ä–æ–¥–∞–≤—Ü—è:
    {full_history}

    –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–∞ —Ç–∞–∫–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏:
    1. –ß—ñ—Ç–∫—ñ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤
    2. –í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—é
    3. –ù–∞—è–≤–Ω—ñ—Å—Ç—å –¥–æ–∫–∞–∑—ñ–≤ —á–∏ –ø—Ä–∏–∫–ª–∞–¥—ñ–≤
    4. –õ–æ–≥—ñ—á–Ω–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å

    –û—Ü—ñ–Ω–∏ –∑–∞ —à–∫–∞–ª–æ—é:
    - "–ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤–æ" (—è–∫—â–æ —î —Ö–æ—á–∞ –± 3 —Å–∏–ª—å–Ω—ñ –∞—Ä–≥—É–º–µ–Ω—Ç–∏)
    - "—á–∞—Å—Ç–∫–æ–≤–æ –ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤–æ" (1‚Äì2 –∞—Ä–≥—É–º–µ–Ω—Ç–∏)
    - "–Ω–µ–ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤–æ" (–Ω–µ–º–∞—î –≤–∞–≥–æ–º–∏—Ö –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤)
    """

            try:
                response = openai.ChatCompletion.create(
                    model="gpt-3.5-turbo",
                    messages=[
                        {"role": "system", "content": "–¢–∏ ‚Äî –µ–∫—Å–ø–µ—Ä—Ç –∑ –æ—Ü—ñ–Ω–∫–∏ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ–π. –ë—É–¥—å –æ–±'—î–∫—Ç–∏–≤–Ω–∏–º."},
                        {"role": "user", "content": evaluation_prompt}
                    ],
                    temperature=0.3,
                    max_tokens=50
                )

                rating = response.choices[0].message["content"].strip().lower()
                print(f"–û—Ü—ñ–Ω–∫–∞: {rating}")

                # –ë–∞–ª –∑–∞ –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è
                if "–ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤–æ" in rating:
                    objection_score = 2
                elif "—á–∞—Å—Ç–∫–æ–≤–æ" in rating:
                    objection_score = 1
                else:
                    objection_score = 0

                # –ü—ñ–¥—Å—É–º–∫–æ–≤–∞ –æ—Ü—ñ–Ω–∫–∞
                model_score = session.get("model_score", 0)
                answers = session.get("user_answers", {})
                answer_score = sum(a.get("score", 0) for a in answers.values())
                total_score = model_score + answer_score + objection_score

                if total_score >= 8:
                    final_feedback = "üîù –ß—É–¥–æ–≤–æ! –í–∏ –¥—É–∂–µ –≤–ø–µ–≤–Ω–µ–Ω–æ –ø—Ä–æ–≤–µ–ª–∏ –∫–ª—ñ—î–Ω—Ç–∞ –¥–æ –ø–æ–∫—É–ø–∫–∏."
                elif total_score >= 5:
                    final_feedback = "üëç –í–∞—à—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –±—É–ª–∏ —Ö–æ—Ä–æ—à–∏–º–∏, –∞–ª–µ —î –Ω–∞–¥ —á–∏–º –ø–æ–ø—Ä–∞—Ü—é–≤–∞—Ç–∏."
                else:
                    final_feedback = "‚ö†Ô∏è –Ñ –Ω–µ–¥–æ–ª—ñ–∫–∏ –≤ –ø—ñ–¥—Ö–æ–¥—ñ –¥–æ –∫–ª—ñ—î–Ω—Ç–∞. –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –¥–æ–¥–∞—Ç–∫–æ–≤–µ –Ω–∞–≤—á–∞–Ω–Ω—è."

                if "–ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤–æ" in rating:
                    reply = "–î—è–∫—É—é –∑–∞ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ! –í–∞—à—ñ –∞—Ä–≥—É–º–µ–Ω—Ç–∏ –¥—É–∂–µ –ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤—ñ. –Ø –≥–æ—Ç–æ–≤–∏–π –¥–æ —Å–ø—ñ–≤–ø—Ä–∞—Ü—ñ."
                elif "—á–∞—Å—Ç–∫–æ–≤–æ" in rating:
                    reply = "–î—è–∫—É—é –∑–∞ –ø–æ—è—Å–Ω–µ–Ω–Ω—è. –î–µ—è–∫—ñ –∞—Ä–≥—É–º–µ–Ω—Ç–∏ —î –ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤–∏–º–∏, –∞–ª–µ —É –º–µ–Ω–µ –∑–∞–ª–∏—à–∏–ª–∏—Å—å —Å—É–º–Ω—ñ–≤–∏."
                else:
                    reply = "–ù–∞ –∂–∞–ª—å, –≤–∞—à—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–µ —Ä–æ–∑—Å—ñ—è–ª–∏ –º–æ—ó —Å—É–º–Ω—ñ–≤–∏. –î—è–∫—É—é –∑–∞ —Å–ø—Ä–æ–±—É."

                full_reply = f"{reply}\n\nüìä –í–∞—à–∞ –æ—Ü—ñ–Ω–∫–∞: {total_score}/10\n{final_feedback}"

                session.clear()
                session["objection_round"] = 1

                return jsonify({
                    "reply": full_reply,
                    "chat_ended": True,
                    "rating": rating,
                    "total_score": total_score,
                    "show_restart_button": True
                })

            except Exception as e:
                print(f"–ü–æ–º–∏–ª–∫–∞ –æ—Ü—ñ–Ω–∫–∏: {str(e)}")
                return jsonify({
                    "reply": "–í–∏–±–∞—á—Ç–µ, –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –î–∞–≤–∞–π—Ç–µ —Å–ø—Ä–æ–±—É—î–º–æ —â–µ —Ä–∞–∑?",
                    "chat_ended": False
                })


    # --- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –ª–æ–≥—ñ–∫–∞ –¥–ª—è stage 1 ---
    elif session["stage"] == 1:
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –ø–∏—Ç–∞–Ω–Ω—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–µ
        if is_relevant_question_gpt(user_input, session["situation"]["description"]):
            is_duplicate = user_input.lower() in [q.lower() for q in session["unique_questions"]]

            if not is_duplicate:
                session["unique_questions"].append(user_input)
                session["question_count"] += 1
                question_score = 2  # –Ω–æ–≤–µ —ñ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–µ
            else:
                question_score = 1  # –ø–æ–≤—Ç–æ—Ä–Ω–µ, –∞–ª–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–µ

            session.setdefault("question_scores", []).append({
                "question": user_input,
                "score": question_score
            })

            current_total_question_score = sum(q["score"] for q in session["question_scores"])
            print(f"[DEBUG] –ü–æ—Ç–æ—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –±–∞–ª—ñ–≤ –∑–∞ –ø–∏—Ç–∞–Ω–Ω—è: {current_total_question_score}")

            # –î–æ–¥–∞—î–º–æ –¥–æ —ñ—Å—Ç–æ—Ä—ñ—ó
            session["history"].append({"role": "user", "content": user_input})

            # –ì–µ–Ω–µ—Ä—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å GPT
            try:
                messages = session["history"][-10:]
                response = openai.ChatCompletion.create(
                    model="gpt-3.5-turbo",
                    messages=messages,
                    temperature=0.5,
                    max_tokens=150
                )
                answer = response.choices[0].message["content"].strip()
                session["history"].append({"role": "assistant", "content": answer})

                # –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—ñ—Å–ª—è 8 –ø–∏—Ç–∞–Ω—å
                if session["question_count"] >= 8:
                    if session.get("warning_count", 0) < 2:
                        session["warning_count"] = session.get("warning_count", 0) + 1
                        warning_text = [
                            "–Ø –≤–∂–µ –≤—ñ–¥–ø–æ–≤—ñ–≤ –Ω–∞ –±–∞–≥–∞—Ç–æ –ø–∏—Ç–∞–Ω—å. –ú–æ–∂–ª–∏–≤–æ, –≤–∏ –≤–∂–µ –º–æ–∂–µ—Ç–µ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –º–µ–Ω—ñ –º–æ–¥–µ–ª—å?",
                            "–ú–µ–Ω—ñ –≤–∂–µ –Ω–∞–±—Ä–∏–¥–ª–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –Ω–∞ —Å—Ç—ñ–ª—å–∫–∏ –ø–∏—Ç–∞–Ω—å. –î–∞–≤–∞–π—Ç–µ –≤–∂–µ –¥–æ —Å–ø—Ä–∞–≤–∏!"
                        ][session["warning_count"] - 1]
                        
                        return jsonify({
                            "reply": warning_text,
                            "chat_ended": False,
                            "stage": 1,
                            "question_progress": session["question_count"],
                            "show_model_button": True
                        })
                    else:
                        session["chat_active"] = False
                        return jsonify({
                            "reply": "–ù–∞ —Ü—å–æ–º—É —è –∑–∞–≤–µ—Ä—à—É—é –¥—ñ–∞–ª–æ–≥. –î–æ –ø–æ–±–∞—á–µ–Ω–Ω—è!",
                            "chat_ended": True,
                            "show_restart_button": True
                        })

                # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                return jsonify({
                    "reply": answer,
                    "chat_ended": False,
                    "stage": 1,
                    "question_progress": session["question_count"],
                    "show_model_button": session["question_count"] >= 3
                })

            except Exception as e:
                print(f"[ERROR] –ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: {e}")
                return jsonify({
                    "reply": "–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",
                    "chat_ended": False
                })

        else:
            # –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è ‚Äî 0 –±–∞–ª—ñ–≤
            session["misunderstood_count"] = session.get("misunderstood_count", 0) + 1
            session.setdefault("question_scores", []).append({
                "question": user_input,
                "score": 0
            })

            if session["misunderstood_count"] >= 3:
                session["chat_active"] = False
                return jsonify({
                    "reply": "–í–∏ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –¥–µ–∫—ñ–ª—å–∫–∞ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏—Ö –ø–∏—Ç–∞–Ω—å. –î—ñ–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.",
                    "chat_ended": True,
                    "show_restart_button": True
                })
            else:
                return jsonify({
                    "reply": "–í–∞—à–µ –ø–∏—Ç–∞–Ω–Ω—è –Ω–µ –∑–æ–≤—Å—ñ–º —Å—Ç–æ—Å—É—î—Ç—å—Å—è –≤–∏–±–æ—Ä—É —à—É—Ä—É–ø–æ–≤–µ—Ä—Ç–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ä–º—É–ª—é–≤–∞—Ç–∏ —ñ–Ω—à–µ.",
                    "chat_ended": False
                })
    
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)